<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastery Mode - MŒîTHMŒîTIŒß</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="/css/algebra-tiles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Mastery Mode Specific Styles - Different Feel, Same Brand */
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            color: #fff;
        }

        .mastery-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 2px solid #12B3B3;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .badge-progress {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .badge-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .badge-icon {
            font-size: 48px;
        }

        .badge-details h2 {
            margin: 0;
            font-size: 24px;
            color: #12B3B3;
        }

        .badge-details p {
            margin: 5px 0 0 0;
            opacity: 0.8;
        }

        .progress-bar-container {
            flex: 1;
            max-width: 400px;
            margin: 0 30px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #12B3B3, #16D9D9);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .exit-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .exit-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .mastery-container {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 20px;
            max-width: 1600px;
            margin: 20px auto;
            padding: 0 20px;
            height: calc(100vh - 180px);
        }

        .whiteboard-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .chat-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
        }

        .progress-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .progress-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
        }

        .progress-card h3 {
            margin: 0 0 10px 0;
            color: #12B3B3;
            font-size: 16px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .stat-value {
            font-weight: bold;
            color: #fff;
        }

        #mastery-chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            padding: 15px;
            border-radius: 12px;
            max-width: 90%;
        }

        .message.user {
            background: linear-gradient(135deg, #12B3B3, #16D9D9);
            align-self: flex-end;
            margin-left: auto;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.1);
            align-self: flex-start;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        #mastery-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 16px;
        }

        #mastery-input:focus {
            outline: none;
            border-color: #12B3B3;
        }

        #mastery-send-btn {
            background: linear-gradient(135deg, #12B3B3, #16D9D9);
            border: none;
            color: #fff;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #mastery-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(18, 179, 179, 0.4);
        }

        .whiteboard-placeholder {
            flex: 1;
            background: rgba(255, 255, 255, 0.02);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
        }

        /* PROBLEM DISPLAY INTERFACE */
        #problem-display-container {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid rgba(18, 179, 179, 0.3);
        }

        .phase-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .phase-badge {
            background: linear-gradient(135deg, #12B3B3, #16D9D9);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .phase-badge.i-do { background: linear-gradient(135deg, #667eea, #764ba2); }
        .phase-badge.we-do { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .phase-badge.you-do { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .phase-badge.mastery-check { background: linear-gradient(135deg, #43e97b, #38f9d7); }

        .problem-number {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            font-weight: 600;
        }

        #problem-statement {
            font-size: 20px;
            color: white;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid #12B3B3;
        }

        #problem-statement .math-expression {
            font-size: 24px;
            font-weight: 600;
            color: #16D9D9;
            display: block;
            margin: 10px 0;
        }

        .answer-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #problem-answer-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 14px;
            color: #fff;
            font-size: 18px;
            font-weight: 600;
        }

        #problem-answer-input:focus {
            outline: none;
            border-color: #12B3B3;
            background: rgba(255, 255, 255, 0.15);
        }

        #submit-answer-btn {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            border: none;
            color: #0f3460;
            padding: 14px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        #submit-answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
        }

        #submit-answer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .hint-btn, .skip-btn, .next-problem-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .hint-btn:hover, .skip-btn:hover, .next-problem-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #12B3B3;
        }

        .hint-btn { border-color: #FFC107; color: #FFC107; }
        .hint-btn:hover { background: rgba(255, 193, 7, 0.2); }

        .next-problem-btn {
            background: linear-gradient(135deg, #12B3B3, #16D9D9);
            border: none;
            color: white;
        }
        .next-problem-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(18, 179, 179, 0.4);
        }

        #feedback-display {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #feedback-display.correct {
            background: rgba(67, 233, 123, 0.2);
            border: 2px solid #43e97b;
            color: #43e97b;
        }

        #feedback-display.incorrect {
            background: rgba(245, 87, 108, 0.2);
            border: 2px solid #f5576c;
            color: #f5576c;
        }

        #feedback-display.hint {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #FFC107;
            color: #FFC107;
        }

        .feedback-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .feedback-text {
            font-size: 15px;
            line-height: 1.5;
        }

        @media (max-width: 1200px) {
            .mastery-container {
                grid-template-columns: 1fr 300px;
                height: auto;
            }

            .whiteboard-section {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .mastery-container {
                grid-template-columns: 1fr;
            }

            .progress-section {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Mastery Mode Header with Badge Progress -->
    <div class="mastery-header">
        <div class="badge-progress">
            <div class="badge-info">
                <div class="badge-icon" id="badge-icon">üèÖ</div>
                <div class="badge-details">
                    <h2 id="badge-name">Loading...</h2>
                    <p id="badge-skill">Skill: Loading...</p>
                </div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%">
                        <span id="progress-text">0/5</span>
                    </div>
                </div>
            </div>
            <button class="exit-button" onclick="exitMasteryMode()">
                <i class="fas fa-sign-out-alt"></i> Exit Mastery Mode
            </button>
        </div>
    </div>

    <!-- Main Mastery Interface -->
    <div class="mastery-container">
        <!-- Whiteboard Section (Left/Top) -->
        <div class="whiteboard-section">
            <h3 style="margin-top: 0; color: #12B3B3;">Visual Teaching Board</h3>
            <div class="whiteboard-placeholder">
                <p><i class="fas fa-chalkboard"></i> Whiteboard will appear here as tutor teaches</p>
            </div>
        </div>

        <!-- Chat Section (Center) -->
        <div class="chat-section">
            <!-- Problem Display Area -->
            <div id="problem-display-container" style="display: none;">
                <div class="phase-indicator">
                    <span class="phase-badge" id="current-phase">Launch</span>
                    <span class="problem-number" id="problem-counter">Problem 1 of 5</span>
                </div>

                <div id="problem-statement">
                    <p>Loading problem...</p>
                </div>

                <div class="answer-area">
                    <input
                        type="text"
                        id="problem-answer-input"
                        placeholder="Type your answer here..."
                        autocomplete="off"
                    >
                    <button id="submit-answer-btn">
                        <i class="fas fa-check"></i> Submit
                    </button>
                </div>

                <div class="action-buttons">
                    <button class="hint-btn" id="request-hint-btn">
                        <i class="fas fa-lightbulb"></i> Get Hint
                    </button>
                    <button class="next-problem-btn" id="next-problem-btn" style="display: none;">
                        <i class="fas fa-arrow-right"></i> Next Problem
                    </button>
                </div>

                <div id="feedback-display">
                    <span class="feedback-icon"></span>
                    <span class="feedback-text"></span>
                </div>
            </div>

            <div id="mastery-chat-box">
                <!-- Messages will appear here -->
            </div>
            <div class="input-area">
                <div class="input-container">
                    <button id="algebra-tiles-btn" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); margin-right: 10px; padding: 12px 20px; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px;" title="Algebra Tiles">
                        <i class="fas fa-th"></i> Tiles
                    </button>
                    <input
                        type="text"
                        id="mastery-input"
                        placeholder="Type your answer or question..."
                        autocomplete="off"
                    >
                    <button id="mastery-send-btn">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Section (Right) -->
        <div class="progress-section">
            <div class="progress-card">
                <h3><i class="fas fa-trophy"></i> Current Badge</h3>
                <div class="stat-row">
                    <span>Badge:</span>
                    <span class="stat-value" id="sidebar-badge-name">Loading...</span>
                </div>
                <div class="stat-row">
                    <span>Tier:</span>
                    <span class="stat-value" id="sidebar-badge-tier">-</span>
                </div>
                <div class="stat-row">
                    <span>Skill:</span>
                    <span class="stat-value" id="sidebar-skill-name">-</span>
                </div>
            </div>

            <div class="progress-card">
                <h3><i class="fas fa-chart-line"></i> Progress</h3>
                <div class="stat-row">
                    <span>Problems:</span>
                    <span class="stat-value" id="sidebar-problems">0/5</span>
                </div>
                <div class="stat-row">
                    <span>Accuracy:</span>
                    <span class="stat-value" id="sidebar-accuracy">0%</span>
                </div>
                <div class="stat-row">
                    <span>Required:</span>
                    <span class="stat-value" id="sidebar-required-accuracy">80%</span>
                </div>
            </div>

            <div class="progress-card">
                <h3><i class="fas fa-graduation-cap"></i> Lesson Phase</h3>
                <div id="sidebar-phase" style="color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.6;">
                    Follow along as your tutor guides you through structured lessons
                </div>
            </div>

            <div class="progress-card">
                <h3><i class="fas fa-lightbulb"></i> Quick Tips</h3>
                <ul style="margin: 0; padding-left: 20px; color: rgba(255, 255, 255, 0.7); font-size: 13px; line-height: 1.6;">
                    <li>Ask questions anytime</li>
                    <li>Show your work for feedback</li>
                    <li>Take your time - accuracy over speed</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Initialize mastery mode
        async function initializeMasteryMode() {
            try {
                // Get user data
                const userRes = await fetch('/user', { credentials: 'include' });
                if (!userRes.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                const data = await userRes.json();
                currentUser = data.user;

                // Check if user has active badge
                if (!currentUser.masteryProgress || !currentUser.masteryProgress.activeBadge) {
                    alert('No active badge. Please select a badge first.');
                    window.location.href = '/badge-map.html';
                    return;
                }

                // Update header and sidebar with badge info
                const badge = currentUser.masteryProgress.activeBadge;
                const tierEmoji = { bronze: 'ü•â', silver: 'ü•à', gold: 'ü•á', platinum: 'üíé' };
                const tierNames = { bronze: 'Bronze', silver: 'Silver', gold: 'Gold', platinum: 'Platinum' };

                // Header
                document.getElementById('badge-icon').textContent = tierEmoji[badge.tier] || 'üèÖ';
                document.getElementById('badge-name').textContent = badge.badgeName;
                document.getElementById('badge-skill').textContent = `Skill: ${badge.skillId.replace(/-/g, ' ')}`;

                // Sidebar - Current Badge
                document.getElementById('sidebar-badge-name').textContent = badge.badgeName;
                document.getElementById('sidebar-badge-tier').textContent = tierNames[badge.tier] || 'Standard';
                document.getElementById('sidebar-skill-name').textContent = badge.skillId.replace(/-/g, ' ');

                // Sidebar - Progress
                const completed = badge.problemsCompleted || 0;
                const correct = badge.problemsCorrect || 0;
                const accuracy = completed > 0 ? Math.round((correct / completed) * 100) : 0;
                const requiredAccuracy = Math.round((badge.requiredAccuracy || 0.8) * 100);

                document.getElementById('sidebar-problems').textContent = `${completed}/${badge.requiredProblems}`;
                document.getElementById('sidebar-accuracy').textContent = `${accuracy}%`;
                document.getElementById('sidebar-required-accuracy').textContent = `${requiredAccuracy}%`;

                updateProgress(completed, badge.requiredProblems);

                // Send welcome message and start practice
                appendMessage('ai', `Welcome to ${badge.badgeName}! Let's start working on ${badge.skillId.replace(/-/g, ' ')}.`);

                // Auto-start practice after a brief delay
                setTimeout(() => startPractice(), 1500);

            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error loading mastery mode. Please try again.');
                window.location.href = '/chat.html';
            }
        }

        // Update progress bar
        function updateProgress(completed, required) {
            const percentage = (completed / required) * 100;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${completed}/${required}`;
        }

        // Append message to chat
        function appendMessage(role, content) {
            const chatBox = document.getElementById('mastery-chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = content;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('mastery-input');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            appendMessage('user', message);
            input.value = '';

            // Create temporary AI message element for streaming
            const chatBox = document.getElementById('mastery-chat-box');
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'message ai';
            aiMessageDiv.textContent = '...';
            chatBox.appendChild(aiMessageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                // Send to mastery chat API
                const response = await fetch('/api/mastery/chat?stream=true', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        userId: currentUser._id,
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to send message');
                }

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let aiMessage = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.chunk) {
                                    aiMessage += data.chunk;
                                    // Update the message in real-time
                                    aiMessageDiv.textContent = aiMessage;
                                    chatBox.scrollTop = chatBox.scrollHeight;
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }

                // Ensure final message is displayed
                if (aiMessage) {
                    aiMessageDiv.textContent = aiMessage;
                }

            } catch (error) {
                console.error('Send error:', error);
                aiMessageDiv.textContent = 'Sorry, there was an error. Please try again.';
            }
        }

        // Exit mastery mode
        function exitMasteryMode() {
            if (confirm('Exit mastery mode and return to regular chat?')) {
                window.location.href = '/chat.html';
            }
        }

        // ============================================================================
        // PROBLEM-SOLVING INTERFACE
        // ============================================================================

        let currentProblem = null;
        let currentPhase = 'launch';

        // Load next problem from backend
        async function loadNextProblem() {
            try {
                const response = await fetch('/api/mastery/next-phase-problem', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load problem');
                }

                const data = await response.json();
                currentProblem = data.problem;
                currentPhase = data.phase || currentPhase;

                displayProblem(currentProblem);
                updatePhaseDisplay(currentPhase);

                // Show problem container, hide next button
                document.getElementById('problem-display-container').style.display = 'block';
                document.getElementById('next-problem-btn').style.display = 'none';
                document.getElementById('feedback-display').style.display = 'none';
                document.getElementById('submit-answer-btn').disabled = false;
                document.getElementById('problem-answer-input').value = '';

            } catch (error) {
                console.error('Error loading problem:', error);
                appendMessage('ai', 'Having trouble loading the next problem. Let me try again...');
            }
        }

        // Display problem in UI
        function displayProblem(problem) {
            const problemStatement = document.getElementById('problem-statement');

            if (problem.type === 'multiple-choice') {
                let html = `<p>${problem.question}</p>`;
                html += '<div style="margin-top: 15px;">';
                problem.choices.forEach((choice, idx) => {
                    html += `<div style="margin: 8px 0;">
                        <strong>${String.fromCharCode(65 + idx)}.</strong> ${choice}
                    </div>`;
                });
                html += '</div>';
                problemStatement.innerHTML = html;
                document.getElementById('problem-answer-input').placeholder = 'Type A, B, C, or D...';
            } else if (problem.type === 'expression' || problem.type === 'equation') {
                problemStatement.innerHTML = `
                    <p>${problem.question}</p>
                    ${problem.expression ? `<div class="math-expression">${problem.expression}</div>` : ''}
                `;
                document.getElementById('problem-answer-input').placeholder = 'Type your answer...';
            } else {
                problemStatement.innerHTML = `<p>${problem.question || problem.problem || 'Solve this problem'}</p>`;
                document.getElementById('problem-answer-input').placeholder = 'Type your answer...';
            }

            // Update problem counter
            const badge = currentUser.masteryProgress.activeBadge;
            const completed = (badge.problemsCompleted || 0) + 1;
            document.getElementById('problem-counter').textContent = `Problem ${completed} of ${badge.requiredProblems}`;
        }

        // Update phase display
        function updatePhaseDisplay(phase) {
            const phaseBadge = document.getElementById('current-phase');
            const phaseNames = {
                'launch': 'Launch',
                'i-do': 'I Do (Watch)',
                'we-do': 'We Do (Together)',
                'you-do': 'You Do (Practice)',
                'mastery-check': 'Mastery Check'
            };

            phaseBadge.textContent = phaseNames[phase] || phase;
            phaseBadge.className = 'phase-badge ' + phase;
        }

        // Submit answer
        async function submitAnswer() {
            const answerInput = document.getElementById('problem-answer-input');
            const answer = answerInput.value.trim();

            if (!answer) {
                alert('Please enter an answer');
                return;
            }

            if (!currentProblem) {
                alert('No active problem');
                return;
            }

            try {
                const response = await fetch('/api/mastery/record-phase-attempt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        problemId: currentProblem.id || currentProblem.problemId,
                        studentAnswer: answer,
                        phase: currentPhase
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to submit answer');
                }

                const result = await response.json();

                // Update current user progress
                if (result.masteryProgress) {
                    currentUser.masteryProgress = result.masteryProgress;

                    const badge = currentUser.masteryProgress.activeBadge;
                    const completed = badge.problemsCompleted || 0;
                    const correct = badge.problemsCorrect || 0;
                    const accuracy = completed > 0 ? Math.round((correct / completed) * 100) : 0;

                    updateProgress(completed, badge.requiredProblems);
                    document.getElementById('sidebar-problems').textContent = `${completed}/${badge.requiredProblems}`;
                    document.getElementById('sidebar-accuracy').textContent = `${accuracy}%`;
                }

                displayFeedback(result.correct, result.feedback, result.correctAnswer);

                // Disable submit button after answer
                document.getElementById('submit-answer-btn').disabled = true;

                // Check if badge is complete
                if (result.badgeComplete) {
                    setTimeout(() => showBadgeCompletion(result), 2000);
                } else {
                    // Show next problem button
                    document.getElementById('next-problem-btn').style.display = 'inline-block';
                }

            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('Error submitting answer. Please try again.');
            }
        }

        // Display feedback
        function displayFeedback(isCorrect, feedback, correctAnswer) {
            const feedbackDisplay = document.getElementById('feedback-display');
            const icon = feedbackDisplay.querySelector('.feedback-icon');
            const text = feedbackDisplay.querySelector('.feedback-text');

            feedbackDisplay.className = '';
            feedbackDisplay.classList.add(isCorrect ? 'correct' : 'incorrect');

            icon.innerHTML = isCorrect ? '‚úÖ' : '‚ùå';

            let feedbackText = feedback || (isCorrect ? 'Correct!' : 'Not quite right.');
            if (!isCorrect && correctAnswer) {
                feedbackText += ` The correct answer is: ${correctAnswer}`;
            }

            text.textContent = feedbackText;
            feedbackDisplay.style.display = 'flex';
            feedbackDisplay.style.alignItems = 'center';
        }

        // Request hint
        async function requestHint() {
            if (!currentProblem) {
                alert('No active problem');
                return;
            }

            try {
                const response = await fetch('/api/mastery/request-hint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        problemId: currentProblem.id || currentProblem.problemId,
                        currentAnswer: document.getElementById('problem-answer-input').value.trim(),
                        phase: currentPhase
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get hint');
                }

                const result = await response.json();

                // Display hint in feedback area
                const feedbackDisplay = document.getElementById('feedback-display');
                const icon = feedbackDisplay.querySelector('.feedback-icon');
                const text = feedbackDisplay.querySelector('.feedback-text');

                feedbackDisplay.className = 'hint';
                icon.innerHTML = 'üí°';
                text.textContent = result.hint || 'Try breaking the problem into smaller steps.';
                feedbackDisplay.style.display = 'flex';
                feedbackDisplay.style.alignItems = 'center';

            } catch (error) {
                console.error('Error requesting hint:', error);
                appendMessage('ai', 'Let me help you with that... ' + (error.message || 'Try thinking about what the problem is asking.'));
            }
        }

        // Show badge completion
        function showBadgeCompletion(result) {
            const badge = currentUser.masteryProgress.activeBadge;

            // Hide problem display
            document.getElementById('problem-display-container').style.display = 'none';

            // Show completion message
            appendMessage('ai', `üéâ Congratulations! You've earned the ${badge.badgeName} badge!`);
            appendMessage('ai', `You completed ${badge.problemsCompleted} problems with ${Math.round((badge.problemsCorrect / badge.problemsCompleted) * 100)}% accuracy.`);
            appendMessage('ai', 'Redirecting you back to the Badge Map...');

            // Redirect after 3 seconds
            setTimeout(() => {
                window.location.href = '/badge-map.html';
            }, 3000);
        }

        // Start practicing - load first problem
        function startPractice() {
            appendMessage('ai', 'Great! Let\'s begin with your first problem.');
            setTimeout(() => loadNextProblem(), 1000);
        }

        // Event listeners
        document.getElementById('submit-answer-btn').addEventListener('click', submitAnswer);
        document.getElementById('problem-answer-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitAnswer();
        });
        document.getElementById('request-hint-btn').addEventListener('click', requestHint);
        document.getElementById('next-problem-btn').addEventListener('click', loadNextProblem);

        document.getElementById('mastery-send-btn').addEventListener('click', sendMessage);
        document.getElementById('mastery-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMasteryMode);
        } else {
            initializeMasteryMode();
        }
    </script>

    <!-- Algebra Tiles Container -->
    <div id="algebraTilesContainer"></div>
    <script src="/js/algebra-tiles.js"></script>
</body>
</html>
