<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Character Rigging Portal - M∆THM∆TIΧ AI</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/css/character-rigging.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />
</head>
<body class="landing-page-body">
  <header class="landing-header">
    <div class="header-logo-container">
      <img src="/images/mathmatix-ai-logo.png" alt="Mathmatix Logo" class="main-logo-hero" />
      <h1 style="margin-left: 15px; color: #fff;">Character Rigging Portal</h1>
    </div>
    <nav class="landing-nav">
      <button id="back-to-chat-btn" class="btn btn-tertiary" title="Back to Chat">
        <i class="fas fa-arrow-left"></i> <span class="mobile-hide">Back to Chat</span>
      </button>
      <button id="my-sessions-btn" class="btn btn-tertiary" title="My Sessions">
        <i class="fas fa-folder-open"></i> <span class="mobile-hide">My Sessions</span>
      </button>
      <button id="logoutBtn" class="btn btn-tertiary logout-button" title="Logout">
        <i class="fas fa-sign-out-alt"></i> <span class="mobile-hide">Logout</span>
      </button>
    </nav>
  </header>

  <main id="rigging-workspace">
    <!-- Upload Section -->
    <section id="upload-section" class="workflow-section active">
      <div class="section-content">
        <div class="upload-card">
          <div class="upload-icon">
            <i class="fas fa-image"></i>
          </div>
          <h2>Upload Your Character</h2>
          <p>Upload a PNG or JPEG image of your character to begin rigging</p>

          <div class="upload-area" id="upload-dropzone">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag & drop your character image here</p>
            <p class="upload-hint">or</p>
            <button class="btn btn-primary" id="browse-file-btn">
              <i class="fas fa-folder-open"></i> Browse Files
            </button>
            <input type="file" id="file-input" accept="image/png,image/jpeg,image/jpg" style="display: none;" />
          </div>

          <div class="character-name-input" style="margin-top: 20px;">
            <label for="character-name">Character Name (optional):</label>
            <input type="text" id="character-name" placeholder="e.g., Hero Character" class="form-input" />
          </div>
        </div>
      </div>
    </section>

    <!-- Rigging Section -->
    <section id="rigging-section" class="workflow-section">
      <div class="section-content">
        <div class="rigging-header">
          <h2 id="current-character-name">Character Rigging</h2>
          <div class="rigging-controls">
            <button class="btn btn-secondary" id="remove-bg-btn" title="Auto-remove solid background">
              <i class="fas fa-magic"></i> Remove Background
            </button>
            <button class="btn btn-secondary" id="undo-btn" title="Undo last action (Ctrl+Z)">
              <i class="fas fa-undo"></i> Undo
            </button>
            <button class="btn btn-secondary" id="redo-btn" title="Redo (Ctrl+Y)">
              <i class="fas fa-redo"></i> Redo
            </button>
            <button class="btn btn-secondary" id="load-template-btn" title="Load preset rigging points">
              <i class="fas fa-download"></i> Load Template
            </button>
            <button class="btn btn-secondary" id="clear-points-btn" title="Clear all rigging points">
              <i class="fas fa-eraser"></i> Clear Points
            </button>
            <button class="btn btn-primary" id="segment-btn" title="Segment character into parts">
              <i class="fas fa-cut"></i> Segment Character
            </button>
          </div>
        </div>

        <div class="rigging-workspace-container">
          <!-- Left Sidebar - Tools -->
          <aside class="rigging-tools">
            <h3>Rigging Tools</h3>

            <div class="tool-section">
              <h4>Point Type</h4>
              <div class="point-type-selector">
                <button class="point-type-btn active" data-type="head">
                  <i class="fas fa-circle"></i> Head
                </button>
                <button class="point-type-btn" data-type="neck">
                  <i class="fas fa-circle"></i> Neck
                </button>
                <button class="point-type-btn" data-type="shoulder">
                  <i class="fas fa-circle"></i> Shoulder
                </button>
                <button class="point-type-btn" data-type="elbow">
                  <i class="fas fa-circle"></i> Elbow
                </button>
                <button class="point-type-btn" data-type="wrist">
                  <i class="fas fa-circle"></i> Wrist
                </button>
                <button class="point-type-btn" data-type="hand">
                  <i class="fas fa-circle"></i> Hand
                </button>
                <button class="point-type-btn" data-type="hip">
                  <i class="fas fa-circle"></i> Hip
                </button>
                <button class="point-type-btn" data-type="knee">
                  <i class="fas fa-circle"></i> Knee
                </button>
                <button class="point-type-btn" data-type="ankle">
                  <i class="fas fa-circle"></i> Ankle
                </button>
                <button class="point-type-btn" data-type="foot">
                  <i class="fas fa-circle"></i> Foot
                </button>
                <button class="point-type-btn" data-type="torso">
                  <i class="fas fa-circle"></i> Torso
                </button>
                <button class="point-type-btn" data-type="custom">
                  <i class="fas fa-circle"></i> Custom
                </button>
              </div>
            </div>

            <div class="tool-section">
              <h4>Side</h4>
              <div class="side-selector">
                <button class="side-btn active" data-side="left">Left</button>
                <button class="side-btn" data-side="right">Right</button>
                <button class="side-btn" data-side="center">Center</button>
              </div>
            </div>

            <div class="tool-section">
              <h4>Instructions</h4>
              <ul class="instruction-list">
                <li><i class="fas fa-mouse-pointer"></i> Click on the image to add rigging points</li>
                <li><i class="fas fa-link"></i> Shift+Click between points to create bones</li>
                <li><i class="fas fa-trash"></i> Right-click a point to delete it</li>
                <li><i class="fas fa-arrows-alt"></i> Drag points to reposition</li>
                <li><i class="fas fa-undo"></i> Ctrl+Z to undo, Ctrl+Y to redo</li>
              </ul>
            </div>

            <div class="tool-section rigging-guide">
              <h4><i class="fas fa-lightbulb"></i> Rigging Guide</h4>
              <div class="guide-content">
                <p><strong>For best results:</strong></p>
                <ol class="guide-steps">
                  <li><strong>Remove Background First</strong> - Use "Remove Background" button before adding points</li>
                  <li><strong>Start with joints</strong> - Head → Neck → Shoulders → Elbows → Wrists</li>
                  <li><strong>Avoid overlaps</strong> - Place points ON the body part, not on edges</li>
                  <li><strong>Use both sides</strong> - Add left_shoulder AND right_shoulder for symmetric parts</li>
                  <li><strong>Create bones</strong> - Shift+Click between connected joints</li>
                </ol>
                <p><strong>For this character:</strong></p>
                <ul class="character-tips">
                  <li>✓ Head: Center of glasses/face</li>
                  <li>✓ Neck: Where collar meets</li>
                  <li>✓ Shoulders: Where suit meets arms</li>
                  <li>✓ Elbows: Bend point of arms</li>
                  <li>✓ Wrists: Where hands begin</li>
                  <li>✓ Hips: Where pants meet torso</li>
                  <li>✓ Knees: Middle of leg</li>
                  <li>✓ Ankles: Where feet meet legs</li>
                </ul>
              </div>
            </div>

            <div class="tool-section points-list-section">
              <h4>Rigging Points (<span id="point-count">0</span>)</h4>
              <div id="points-list" class="points-list"></div>
            </div>
          </aside>

          <!-- Center Canvas -->
          <div class="canvas-container">
            <div class="canvas-controls">
              <button class="btn btn-sm" id="zoom-in-btn" title="Zoom In">
                <i class="fas fa-search-plus"></i>
              </button>
              <button class="btn btn-sm" id="zoom-out-btn" title="Zoom Out">
                <i class="fas fa-search-minus"></i>
              </button>
              <button class="btn btn-sm" id="reset-view-btn" title="Center & Reset View">
                <i class="fas fa-compress-arrows-alt"></i>
              </button>
              <label class="toggle-label">
                <input type="checkbox" id="show-bones-toggle" checked />
                Show Bones
              </label>
              <label class="toggle-label">
                <input type="checkbox" id="show-labels-toggle" checked />
                Show Labels
              </label>
              <span class="canvas-hint">
                <i class="fas fa-info-circle"></i> Hold SPACEBAR and drag to pan
              </span>
            </div>
            <canvas id="rigging-canvas"></canvas>
            <div id="canvas-loading" class="canvas-loading" style="display: none;">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Loading image...</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Results Section -->
    <section id="results-section" class="workflow-section">
      <div class="section-content">
        <div class="results-header">
          <h2>Segmented Parts</h2>
          <div class="results-actions">
            <button class="btn btn-secondary" id="back-to-rigging-btn">
              <i class="fas fa-arrow-left"></i> Back to Rigging
            </button>
            <button class="btn btn-secondary" id="resolve-overlaps-btn" title="Resolve overlapping body parts">
              <i class="fas fa-compress-arrows-alt"></i> Resolve Overlaps
            </button>
            <button class="btn btn-secondary" id="refine-mode-btn" title="Manually refine segment boundaries">
              <i class="fas fa-pen"></i> Refine Masks
            </button>
            <button class="btn btn-primary" id="download-parts-btn">
              <i class="fas fa-download"></i> Download All Parts
            </button>
          </div>
        </div>

        <div class="results-info">
          <p>Your character has been successfully segmented into <strong id="segment-count">0</strong> parts.</p>
          <p>Each part is ready to be imported into your animation software.</p>
        </div>

        <div id="segmented-parts-grid" class="parts-grid">
          <!-- Parts will be dynamically inserted here -->
        </div>

        <!-- Brush Editing Panel (Hidden by default) -->
        <div id="brush-editor-panel" class="brush-editor-panel" style="display: none;">
          <div class="brush-editor-header">
            <h3><i class="fas fa-paint-brush"></i> Brush Editor</h3>
            <button class="btn btn-sm btn-secondary" id="close-brush-editor-btn">
              <i class="fas fa-times"></i> Close
            </button>
          </div>

          <div class="brush-editor-content">
            <!-- Segment Selector -->
            <div class="brush-control-group">
              <label>Select Segment to Edit:</label>
              <select id="segment-selector" class="segment-selector">
                <!-- Options populated dynamically -->
              </select>
            </div>

            <!-- Brush Tools -->
            <div class="brush-control-group">
              <label>Brush Mode:</label>
              <div class="brush-mode-btns">
                <button class="btn btn-sm brush-mode-btn active" data-mode="add">
                  <i class="fas fa-plus"></i> Add
                </button>
                <button class="btn btn-sm brush-mode-btn" data-mode="remove">
                  <i class="fas fa-minus"></i> Remove
                </button>
              </div>
            </div>

            <!-- Brush Size -->
            <div class="brush-control-group">
              <label>Brush Size: <span id="brush-size-value">20</span>px</label>
              <input type="range" id="brush-size-slider" min="5" max="100" value="20" class="brush-size-slider" />
            </div>

            <!-- Preview Canvas -->
            <div class="brush-preview-container">
              <canvas id="brush-preview-canvas"></canvas>
              <div class="brush-preview-info">
                <p><i class="fas fa-mouse-pointer"></i> Paint on the canvas to add/remove pixels</p>
                <p><i class="fas fa-eye"></i> Preview shows the current mask overlay</p>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="brush-actions">
              <button class="btn btn-secondary" id="brush-undo-btn">
                <i class="fas fa-undo"></i> Undo
              </button>
              <button class="btn btn-secondary" id="brush-reset-btn">
                <i class="fas fa-refresh"></i> Reset Segment
              </button>
              <button class="btn btn-primary" id="brush-apply-btn">
                <i class="fas fa-check"></i> Apply Changes
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sessions Modal -->
    <div id="sessions-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>My Rigging Sessions</h2>
          <button class="close-modal" id="close-sessions-modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div id="sessions-list" class="sessions-list">
            <!-- Sessions will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Load Rigging Template</h2>
          <button class="close-modal" id="close-template-modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <p>Select a preset template to quickly add rigging points:</p>
          <div class="template-options">
            <button class="template-btn" data-template="humanoid">
              <i class="fas fa-user"></i>
              <span>Humanoid (Full Body)</span>
            </button>
            <button class="template-btn" data-template="humanoid-simple">
              <i class="fas fa-user-alt"></i>
              <span>Humanoid (Simple)</span>
            </button>
            <button class="template-btn" data-template="quadruped">
              <i class="fas fa-dog"></i>
              <span>Quadruped (4-legged)</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div id="loading-overlay" style="display: none;">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p id="loading-message">Processing...</p>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast-notification" class="toast-notification"></div>

  <!-- Scripts -->
  <script src="/js/character-rigging.js"></script>
  <script>
    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/logout', { method: 'POST' });
      window.location.href = '/';
    });

    // Back to chat
    document.getElementById('back-to-chat-btn').addEventListener('click', () => {
      window.location.href = '/chat.html';
    });
  </script>
<script src="/js/csrf.js"></script>
</body>
</html>
