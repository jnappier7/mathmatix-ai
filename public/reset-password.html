<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password - M∆THM∆TIΧ AI</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />
</head>
<body class="landing-page-body">
  <header class="landing-header">
    <div class="header-logo-container">
      <img src="/images/mathmatix-ai-logo.png" alt="Mathmatix AI Logo" class="main-logo-hero" />
    </div>
    <nav class="landing-nav">
      <a href="/login.html" class="btn btn-secondary">Back to Login</a>
    </nav>
  </header>

  <main class="login-page-wrapper">
    <div class="login-container">
      <div id="verifying-token" style="text-align: center; padding: 30px 0;">
        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #667eea;"></i>
        <p style="margin-top: 15px; color: #666;">Verifying reset link...</p>
      </div>

      <div id="token-invalid" style="display: none; text-align: center;">
        <div style="background: #fff5f5; border-left: 4px solid #e74c3c; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <i class="fas fa-times-circle" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
          <h2 style="margin: 0 0 10px 0; color: #2c3e50;">Invalid or Expired Link</h2>
          <p style="margin: 0; color: #555;">This password reset link is invalid or has expired.</p>
        </div>
        <a href="/forgot-password.html" class="submit-btn" style="display: inline-block; text-decoration: none;">
          Request New Reset Link
        </a>
      </div>

      <div id="reset-form-container" style="display: none;">
        <h1>Create New Password</h1>
        <p class="subtitle" id="email-display"></p>

        <form id="resetPasswordForm">
          <label for="newPassword">New Password:</label>
          <div style="position: relative;">
            <input type="password" id="newPassword" name="newPassword" required minlength="8" autocomplete="new-password" />
            <button type="button" id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #667eea; font-size: 18px;">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div id="password-strength" style="margin-top: 5px; font-size: 12px; color: #666;"></div>

          <label for="confirmPassword" style="margin-top: 15px;">Confirm Password:</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required minlength="8" autocomplete="new-password" />

          <button type="submit" class="submit-btn" id="submitBtn" style="margin-top: 20px;">
            <span id="btnText">Reset Password</span>
            <span id="btnLoading" style="display: none;">
              <i class="fas fa-spinner fa-spin"></i> Resetting...
            </span>
          </button>
        </form>

        <div id="message" class="error-message" style="display: none; text-align: center; margin-top: 15px;"></div>
        <div id="success-message" class="success-message" style="display: none; text-align: center; margin-top: 15px; color: #27ae60; background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;"></div>
      </div>
    </div>
  </main>

  <footer>
    <p>© 2025 M∆THM∆TIΧ AI. All rights reserved.</p>
    <p>
      <a href="/privacy.html">Privacy Policy</a> |
      <a href="/terms.html">Terms of Use</a>
    </p>
  </footer>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const resetToken = urlParams.get('token');

    const verifyingDiv = document.getElementById('verifying-token');
    const invalidDiv = document.getElementById('token-invalid');
    const formContainer = document.getElementById('reset-form-container');
    const messageDiv = document.getElementById('message');
    const successMessageDiv = document.getElementById('success-message');
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnLoading = document.getElementById('btnLoading');

    // Password visibility toggle
    const togglePassword = document.getElementById('togglePassword');
    const newPasswordInput = document.getElementById('newPassword');

    togglePassword.addEventListener('click', function() {
      const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      newPasswordInput.setAttribute('type', type);
      this.querySelector('i').classList.toggle('fa-eye');
      this.querySelector('i').classList.toggle('fa-eye-slash');
    });

    // Password strength indicator
    const passwordStrengthDiv = document.getElementById('password-strength');
    newPasswordInput.addEventListener('input', function() {
      const password = this.value;
      let strength = 'Weak';
      let color = '#e74c3c';

      if (password.length >= 12 && /[A-Z]/.test(password) && /[a-z]/.test(password) && /[0-9]/.test(password) && /[^A-Za-z0-9]/.test(password)) {
        strength = 'Very Strong';
        color = '#27ae60';
      } else if (password.length >= 10 && /[A-Z]/.test(password) && /[a-z]/.test(password) && /[0-9]/.test(password)) {
        strength = 'Strong';
        color = '#27ae60';
      } else if (password.length >= 8) {
        strength = 'Medium';
        color = '#f39c12';
      }

      passwordStrengthDiv.textContent = `Password strength: ${strength}`;
      passwordStrengthDiv.style.color = color;
    });

    // Verify token on page load
    async function verifyToken() {
      if (!resetToken) {
        verifyingDiv.style.display = 'none';
        invalidDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`/api/password-reset/verify/${resetToken}`);
        const result = await response.json();

        verifyingDiv.style.display = 'none';

        if (response.ok && result.success) {
          formContainer.style.display = 'block';
          document.getElementById('email-display').textContent = `Reset password for: ${result.email}`;
        } else {
          invalidDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Token verification error:', error);
        verifyingDiv.style.display = 'none';
        invalidDiv.style.display = 'block';
      }
    }

    // Call verifyToken on page load
    verifyToken();

    // Handle form submission
    resetPasswordForm.addEventListener('submit', async function(event) {
      event.preventDefault();

      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Hide previous messages
      messageDiv.style.display = 'none';
      successMessageDiv.style.display = 'none';

      // Validate passwords match
      if (newPassword !== confirmPassword) {
        messageDiv.textContent = 'Passwords do not match';
        messageDiv.style.display = 'block';
        return;
      }

      // Validate password length
      if (newPassword.length < 8) {
        messageDiv.textContent = 'Password must be at least 8 characters long';
        messageDiv.style.display = 'block';
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';

      try {
        const response = await csrfFetch('/api/password-reset/reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            token: resetToken,
            newPassword: newPassword
          })
        });

        const result = await response.json();

        // Hide loading state
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';

        if (response.ok && result.success) {
          successMessageDiv.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <strong>Password Reset Successful!</strong><br>
            Your password has been changed. Redirecting to login...
          `;
          successMessageDiv.style.display = 'block';
          resetPasswordForm.style.display = 'none';

          // Redirect to login after 3 seconds
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 3000);
        } else {
          messageDiv.textContent = result.message || 'Failed to reset password. Please try again.';
          messageDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Password Reset Error:', error);

        // Hide loading state
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';

        messageDiv.textContent = 'An error occurred. Please try again later.';
        messageDiv.style.display = 'block';
      }
    });
  </script>
  <script src="/js/csrf.js"></script>
</body>
</html>
