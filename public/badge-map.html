<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Badge Map - Mastery Mode | MATHMATIX AI</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/css/dailyQuests.css">
  <link rel="stylesheet" href="/css/weeklyChallenges.css">
  <style>
    /* FIXED 3-COLUMN LAYOUT - MASTERY MODE THEME */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
    }

    .page-layout {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* HEADER - MATHMATIX BRANDED */
    .main-header {
      background: white;
      border-bottom: 3px solid #764ba2;
      padding: 15px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      flex-shrink: 0;
      z-index: 100;
    }

    .main-header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .main-logo {
      height: 50px;
      width: auto;
      margin-right: 12px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-name {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: #000;
      margin: 0;
      line-height: 1;
    }

    .brand-tagline {
      font-size: 11px;
      color: #666;
      margin: 2px 0 0 0;
      font-weight: 400;
    }

    .mode-indicator {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .main-header-nav {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .nav-btn {
      color: #555;
      text-decoration: none;
      padding: 10px 18px;
      border-radius: 8px;
      background: #f0f0f0;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nav-btn:hover {
      background: #e0e0e0;
      color: #000;
    }

    .nav-btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .nav-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* 3-COLUMN GRID LAYOUT */
    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1fr 300px;
      gap: 0;
      overflow: hidden;
      background: #f8f9fa;
    }

    /* Left sidebar */
    .left-sidebar {
      background: white;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Center column */
    .center-content {
      overflow-y: auto;
      overflow-x: hidden;
      padding: 25px;
      background: #f8f9fa;
    }

    /* Right sidebar */
    .right-sidebar {
      background: white;
      border-left: 1px solid #e0e0e0;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* FOOTER - CONSISTENT WITH CHAT */
    .main-footer {
      background: #1a1a1a;
      color: white;
      padding: 12px 30px;
      text-align: center;
      font-size: 12px;
      flex-shrink: 0;
      border-top: 3px solid #764ba2;
    }

    .main-footer a {
      color: #667eea;
      text-decoration: none;
      margin: 0 10px;
    }

    .main-footer a:hover {
      text-decoration: underline;
    }

    /* Sidebar sections */
    .sidebar-section {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
    }

    .sidebar-section:last-child {
      border-bottom: none;
    }

    .sidebar-section h3 {
      margin: 0 0 15px 0;
      font-size: 14px;
      color: #333;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Ability indicator - MASTERY PURPLE THEME */
    .ability-compact {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .ability-compact-label {
      font-size: 11px;
      opacity: 0.9;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .ability-compact-bar {
      height: 10px;
      background: rgba(255,255,255,0.3);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .ability-compact-fill {
      height: 100%;
      background: white;
      border-radius: 5px;
      transition: width 0.5s ease;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    .ability-compact-value {
      font-size: 20px;
      font-weight: 700;
    }

    /* Quest/Challenge cards - COMPACT */
    .quest-item {
      font-size: 12px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid #764ba2;
      transition: all 0.2s;
    }

    .quest-item:hover {
      background: #fff;
      border-left-color: #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .quest-item:last-child {
      margin-bottom: 0;
    }

    .progress-link {
      display: block;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-top: 12px;
      text-decoration: none;
      color: #667eea;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s;
    }

    .progress-link:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    /* Badge map header */
    .badge-map-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.05);
      border: 2px solid #f0f0f0;
    }

    .badge-map-header h2 {
      margin: 0 0 10px 0;
      font-size: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }

    .badge-map-header p {
      margin: 0;
      color: #666;
      font-size: 16px;
    }

    /* Domain sections - MASTERY PURPLE ACCENTS */
    .domain {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      border: 2px solid #f0f0f0;
      transition: all 0.3s;
    }

    .domain:hover {
      border-color: #764ba2;
      box-shadow: 0 4px 20px rgba(118, 75, 162, 0.1);
    }

    .domain-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 18px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f5f5f5;
    }

    .domain-icon {
      font-size: 28px;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .domain-title h3 {
      margin: 0;
      font-size: 20px;
      color: #333;
      font-weight: 700;
    }

    .domain-title p {
      margin: 5px 0 0 0;
      font-size: 13px;
      color: #666;
    }

    .badge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .badge-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      position: relative;
    }

    .badge-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      border-color: #667eea;
      background: white;
    }

    .badge-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .badge-card.locked:hover {
      transform: none;
      box-shadow: none;
      border-color: transparent;
    }

    .badge-card.in-progress {
      border-color: #FFC107;
      background: #fffbf0;
    }

    .badge-card.completed {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .badge-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .badge-name {
      font-weight: 700;
      font-size: 14px;
      color: #333;
      margin: 0;
    }

    .badge-tier {
      font-size: 20px;
    }

    .badge-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .badge-progress {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .badge-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .badge-stats {
      font-size: 11px;
      color: #999;
      font-weight: 500;
    }

    /* Right sidebar stats - MASTERY PURPLE THEME */
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 15px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .stat-card h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .stat-card .stat-value {
      font-size: 36px;
      font-weight: 800;
      margin: 0;
    }

    .stat-card .stat-sublabel {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .stat-card.streak {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
    }

    .stat-card.xp {
      background: linear-gradient(135deg, #FFD93D 0%, #FFA500 100%);
    }

    .progress-tool-link {
      display: block;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 10px;
      text-decoration: none;
      color: #333;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      text-align: left;
      border: 2px solid transparent;
    }

    .progress-tool-link:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .progress-tool-link i {
      margin-right: 8px;
      width: 20px;
      text-align: center;
    }

    /* FEATURED MATH BLAST CARD */
    .featured-game-card {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(255, 107, 107, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: block;
      position: relative;
      overflow: hidden;
    }

    .featured-game-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: pulse 3s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .featured-game-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(255, 107, 107, 0.4);
    }

    .featured-game-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .featured-game-title {
      font-size: 20px;
      font-weight: 800;
      color: white;
      margin: 0 0 8px 0;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      z-index: 1;
    }

    .featured-game-subtitle {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.95);
      margin: 0 0 16px 0;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .featured-game-cta {
      background: white;
      color: #FF6B6B;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      z-index: 1;
      transition: all 0.2s;
    }

    .featured-game-card:hover .featured-game-cta {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .featured-game-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 1;
    }

    /* Scrollbar styling */
    .left-sidebar::-webkit-scrollbar,
    .center-content::-webkit-scrollbar,
    .right-sidebar::-webkit-scrollbar {
      width: 8px;
    }

    .left-sidebar::-webkit-scrollbar-track,
    .center-content::-webkit-scrollbar-track,
    .right-sidebar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .left-sidebar::-webkit-scrollbar-thumb,
    .center-content::-webkit-scrollbar-thumb,
    .right-sidebar::-webkit-scrollbar-thumb {
      background: #764ba2;
      border-radius: 4px;
    }

    .left-sidebar::-webkit-scrollbar-thumb:hover,
    .center-content::-webkit-scrollbar-thumb:hover,
    .right-sidebar::-webkit-scrollbar-thumb:hover {
      background: #667eea;
    }

    /* MODERN EXPANDABLE PATTERN CARDS */
    .pattern-card {
      background: white;
      border-radius: 16px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .pattern-card:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .pattern-card.expanded {
      border-color: #667eea;
    }

    .pattern-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 28px;
      cursor: pointer;
      transition: all 0.2s;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    }

    .pattern-card.locked .pattern-card-header {
      cursor: not-allowed;
      opacity: 0.6;
      background: #f5f5f5;
    }

    .pattern-card-header:hover:not(.locked) {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .pattern-card-left {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
    }

    .pattern-card-icon {
      width: 80px;
      height: 80px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }

    .pattern-card-header:hover .pattern-card-icon {
      transform: scale(1.05);
    }

    .pattern-card-info {
      flex: 1;
    }

    .pattern-card-name {
      font-size: 24px;
      font-weight: 800;
      margin: 0 0 6px 0;
      color: #333;
      letter-spacing: 0.5px;
    }

    .pattern-card-description {
      font-size: 14px;
      color: #666;
      margin: 0 0 12px 0;
      line-height: 1.5;
    }

    .pattern-card-meta {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pattern-tier-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .pattern-progress-mini {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #666;
      font-weight: 600;
    }

    .pattern-progress-mini-bar {
      width: 120px;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    .pattern-progress-mini-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .pattern-card-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pattern-expand-icon {
      font-size: 24px;
      color: #667eea;
      transition: transform 0.3s ease;
    }

    .pattern-card.expanded .pattern-expand-icon {
      transform: rotate(180deg);
    }

    .pattern-card-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .pattern-card.expanded .pattern-card-body {
      max-height: 2000px;
    }

    .pattern-card-content {
      padding: 0 28px 28px 28px;
    }

    /* Tier sections within pattern card */
    .tier-section {
      margin-bottom: 24px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .tier-section:last-child {
      margin-bottom: 0;
    }

    .tier-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .tier-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tier-icon {
      font-size: 20px;
    }

    .tier-status {
      font-size: 12px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tier-status.locked { background: #ffebee; color: #c62828; }
    .tier-status.active { background: #fff3e0; color: #f57c00; }
    .tier-status.completed { background: #e8f5e9; color: #2e7d32; }

    /* Milestone sections within tiers */
    .milestones-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .milestone-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid #e0e0e0;
      position: relative;
    }

    .milestone-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      border-color: #667eea;
    }

    .milestone-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .milestone-card.locked:hover {
      transform: none;
      box-shadow: none;
      border-color: #e0e0e0;
    }

    .milestone-card.in-progress {
      border-color: #FFC107;
      background: #fffbf0;
    }

    .milestone-card.completed {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .milestone-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .milestone-name {
      font-weight: 700;
      font-size: 15px;
      color: #333;
      margin: 0;
    }

    .milestone-icon {
      font-size: 24px;
    }

    .milestone-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .milestone-progress {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .milestone-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .milestone-stats {
      font-size: 11px;
      color: #999;
      font-weight: 500;
    }

    /* Individual Pattern Colors */
    .pattern-equivalence { background: #2196f3; }
    .pattern-scaling { background: #4caf50; }
    .pattern-change { background: #ff5722; }
    .pattern-structure { background: #9c27b0; }
    .pattern-space { background: #00bcd4; }
    .pattern-comparison { background: #ff9800; }
    .pattern-uncertainty { background: #e91e63; }
    .pattern-accumulation { background: #795548; }

    .pattern-lock-message {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 14px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="page-layout">
    <!-- HEADER - MATHMATIX BRANDED -->
    <header class="main-header">
      <div class="main-header-content">
        <div class="brand-section">
          <div class="logo-container">
            <img src="/images/mathmatix-ai-logo.png" alt="MATHMATIX AI Logo" class="main-logo" />
          </div>
          <div class="brand-text">
            <h1 class="brand-name">MATHMATIX AI</h1>
            <p class="brand-tagline">Unlock the Pattern. Learn for Life.</p>
          </div>
          <div class="mode-indicator">
            <i class="fas fa-trophy"></i> Mastery Mode
          </div>
        </div>

        <nav class="main-header-nav">
          <a href="/chat.html" class="nav-btn">
            <i class="fas fa-comments"></i> Chat
          </a>
          <a href="/screener.html" class="nav-btn">
            <i class="fas fa-crosshairs"></i> Screener
          </a>
          <button onclick="logout()" class="nav-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </nav>
      </div>
    </header>

    <!-- 3-COLUMN CONTENT -->
    <main class="main-content">
      <!-- LEFT SIDEBAR: Engagement -->
      <aside class="left-sidebar">
        <div class="sidebar-section">
          <div class="ability-compact">
            <div class="ability-compact-label">Your Ability Level</div>
            <div class="ability-compact-bar">
              <div class="ability-compact-fill" id="ability-fill"></div>
            </div>
            <div class="ability-compact-value" id="theta-display">Œ∏ = 0.0</div>
          </div>
        </div>

        <div class="sidebar-section">
          <h3><span>üéØ</span> Today's Quests</h3>
          <div id="mini-quests-container">
            <div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">
              Loading quests...
            </div>
          </div>
          <a href="/daily-quests-widget.html" class="progress-link">
            View All Quests <i class="fas fa-arrow-right"></i>
          </a>
        </div>

        <div class="sidebar-section">
          <h3><span>‚ö°</span> Weekly Challenges</h3>
          <div id="mini-challenges-container">
            <div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">
              Loading challenges...
            </div>
          </div>
          <div id="challenge-timer" style="margin-top: 10px; text-align: center; font-size: 12px; color: #666;">
            <i class="fas fa-clock"></i> <span id="time-remaining">Loading...</span>
          </div>
          <a href="/weekly-challenges.html" class="progress-link">
            View All Challenges <i class="fas fa-arrow-right"></i>
          </a>
        </div>
      </aside>

      <!-- CENTER: Badge Map -->
      <section class="center-content">
        <!-- ARCADE CARD - FLOATING UPPER RIGHT -->
        <div class="arcade-floating-card">
          <a href="/mastery-arcade.html" class="featured-game-card" style="background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%); margin-bottom: 0;">
            <div class="featured-game-badge">üéÆ ARCADE</div>
            <div class="featured-game-icon">üïπÔ∏è</div>
            <h3 class="featured-game-title">M‚àÜSTERY.‚àÜRC‚àÜDE</h3>
            <p class="featured-game-subtitle">Two arcade games ‚Ä¢ Master facts ‚Ä¢ Build streaks</p>
            <div class="featured-game-cta">
              <i class="fas fa-gamepad"></i>
              <span>Enter Arcade</span>
              <i class="fas fa-arrow-right"></i>
            </div>
          </a>
        </div>

        <div class="badge-map-header">
          <h2>üèÜ Badge Map</h2>
          <p>Choose your next mastery challenge</p>
        </div>

        <!-- MODERN PATTERN-BASED MASTERY SYSTEM -->
        <div id="pattern-cards-container">
          <!-- Pattern cards will be loaded here dynamically -->
          <div style="text-align: center; padding: 60px; color: #999;">
            <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #667eea; margin-bottom: 20px;"></i>
            <p>Loading your mastery map...</p>
          </div>
        </div>
      </section>

      <!-- RIGHT SIDEBAR: Progress & Stats -->
      <aside class="right-sidebar">
        <div class="sidebar-section">
          <h3><span>üìä</span> Your Stats</h3>

          <div class="stat-card">
            <h4>Badges Earned</h4>
            <p class="stat-value" id="badges-earned">0</p>
            <p class="stat-sublabel">Total completed</p>
          </div>

          <div class="stat-card streak">
            <h4>Current Streak</h4>
            <p class="stat-value">üî• <span id="streak-count-stat">0</span></p>
            <p class="stat-sublabel">Days in a row</p>
          </div>

          <div class="stat-card xp">
            <h4>Total XP</h4>
            <p class="stat-value" id="total-xp">0</p>
            <p class="stat-sublabel">Experience points</p>
          </div>
        </div>

        <div class="sidebar-section">
          <h3><span>üìà</span> Progress Tools</h3>

          <a href="/my-speed-progress.html" class="progress-tool-link">
            <i class="fas fa-tachometer-alt"></i> Speed Progress
          </a>

          <a href="/my-celeration-charts.html" class="progress-tool-link">
            <i class="fas fa-chart-line"></i> Celeration Charts
          </a>

          <a href="/learning-curves.html" class="progress-tool-link">
            <i class="fas fa-chart-area"></i> Learning Curves
          </a>
        </div>
      </aside>
    </main>

    <!-- FOOTER - CONSISTENT WITH CHAT -->
    <footer class="main-footer">
      ¬© 2025 MATHMATIX AI. All rights reserved.
      <a href="/privacy-policy.html">Privacy Policy</a> |
      <a href="/terms.html">Terms of Use</a>
    </footer>
  </div>

  <script>
    // Load user stats and ability data
    async function loadUserStats() {
      try {
        const response = await fetch('/api/mastery/user-stats', {
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.status === 401) {
          console.warn('[User Stats] Session expired - redirecting to login');
          window.location.href = '/login.html';
          return;
        }

        if (!response.ok) {
          console.warn('Failed to load user stats');
          return;
        }

        const data = await response.json();

        // Update ability display
        updateAbilityDisplay(data.averageTheta || 0);

        // Update stats
        if (document.getElementById('badges-earned')) {
          document.getElementById('badges-earned').textContent = data.badgesEarned || 0;
        }
        if (document.getElementById('total-xp')) {
          document.getElementById('total-xp').textContent = (data.totalXP || 0).toLocaleString();
        }

      } catch (error) {
        console.error('Error loading user stats:', error);
      }
    }

    function updateAbilityDisplay(theta) {
      const thetaDisplay = document.getElementById('theta-display');
      const abilityFill = document.getElementById('ability-fill');

      if (thetaDisplay && abilityFill) {
        thetaDisplay.textContent = `Œ∏ = ${theta.toFixed(2)}`;

        // Map theta (-3 to +3) to percentage (0 to 100%)
        const percentage = Math.max(0, Math.min(100, ((theta + 3) / 6) * 100));
        abilityFill.style.width = `${percentage}%`;
      }
    }

    // New unified pattern-based rendering
    async function loadMasteryMap() {
      try {
        const response = await fetch('/api/mastery/mastery-map');

        if (response.status === 401) {
          console.warn('[Mastery Map] Session expired - redirecting to login');
          window.location.href = '/login.html';
          return;
        }

        if (!response.ok) throw new Error('Failed to load mastery map');

        const data = await response.json();
        renderPatternCards(data.patterns || [], data.assessmentCompleted);

      } catch (error) {
        console.error('Error loading mastery map:', error);
        const container = document.getElementById('pattern-cards-container');
        container.innerHTML = `
          <div style="text-align: center; padding: 60px;">
            <i class="fas fa-info-circle" style="font-size: 48px; color: #667eea; margin-bottom: 20px;"></i>
            <p style="color: #666; font-size: 16px; font-weight: 600;">Complete the screener to unlock mastery mode!</p>
            <a href="/screener.html" style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
              Take Screener <i class="fas fa-arrow-right"></i>
            </a>
          </div>
        `;
      }
    }

    function renderPatternCards(patterns, assessmentCompleted) {
      const container = document.getElementById('pattern-cards-container');

      if (!patterns || patterns.length === 0) {
        if (!assessmentCompleted) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px;">
              <i class="fas fa-info-circle" style="font-size: 48px; color: #667eea; margin-bottom: 20px;"></i>
              <p style="color: #666; font-size: 16px; font-weight: 600;">Complete the screener to unlock mastery mode!</p>
              <a href="/screener.html" style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
                Take Screener <i class="fas fa-arrow-right"></i>
              </a>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px;">
              <i class="fas fa-check-circle" style="font-size: 48px; color: #4CAF50; margin-bottom: 20px;"></i>
              <p style="color: #666; font-size: 16px; font-weight: 600;">Screener completed!</p>
              <p style="color: #999; font-size: 14px;">Your mastery map is being prepared. Check back soon!</p>
            </div>
          `;
        }
        return;
      }

      const iconMap = {
        'equivalence': 'fa-balance-scale',
        'scaling': 'fa-chart-line',
        'change': 'fa-mountain',
        'structure': 'fa-cubes',
        'space': 'fa-cube',
        'comparison': 'fa-sort-amount-up',
        'uncertainty': 'fa-dice',
        'accumulation': 'fa-layer-group'
      };

      container.innerHTML = patterns.map(pattern => {
        const isLocked = !pattern.currentTier || pattern.currentTier === 0;
        const tierIcon = getTierIcon(pattern.currentTier);
        const totalProgress = calculatePatternProgress(pattern);

        return `
          <div class="pattern-card ${isLocked ? 'locked' : ''}" id="pattern-${pattern.patternId}">
            <div class="pattern-card-header" onclick="${isLocked ? '' : `togglePattern('${pattern.patternId}')`}">
              <div class="pattern-card-left">
                <div class="pattern-card-icon pattern-${pattern.patternId}">
                  <i class="fas ${iconMap[pattern.patternId] || 'fa-star'}"></i>
                </div>
                <div class="pattern-card-info">
                  <h3 class="pattern-card-name">${pattern.name}</h3>
                  <p class="pattern-card-description">${pattern.description || 'Master this fundamental mathematical pattern'}</p>
                  <div class="pattern-card-meta">
                    <div class="pattern-tier-badge">
                      ${tierIcon} Tier ${pattern.currentTier || 0}
                    </div>
                    ${!isLocked ? `
                      <div class="pattern-progress-mini">
                        <div class="pattern-progress-mini-bar">
                          <div class="pattern-progress-mini-fill" style="width: ${totalProgress}%"></div>
                        </div>
                        <span>${Math.round(totalProgress)}%</span>
                      </div>
                    ` : '<span style="color: #c62828; font-size: 13px; font-weight: 600;">üîí Complete screener to unlock</span>'}
                  </div>
                </div>
              </div>
              ${!isLocked ? `
                <div class="pattern-card-right">
                  <i class="fas fa-chevron-down pattern-expand-icon"></i>
                </div>
              ` : ''}
            </div>
            ${!isLocked ? `
              <div class="pattern-card-body">
                <div class="pattern-card-content">
                  ${renderTiers(pattern)}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderTiers(pattern) {
      if (!pattern.tiers || pattern.tiers.length === 0) {
        return '<p class="pattern-lock-message">No tiers available yet</p>';
      }

      return pattern.tiers.map((tier, tierIndex) => {
        const tierStatus = getTierStatus(tier, pattern.currentTier, tierIndex + 1);

        return `
          <div class="tier-section">
            <div class="tier-header">
              <div class="tier-title">
                <span class="tier-icon">${getTierIcon(tierIndex + 1)}</span>
                <span>Tier ${tierIndex + 1}: ${tier.name || `Level ${tierIndex + 1}`}</span>
              </div>
              <div class="tier-status ${tierStatus}">${getTierStatusText(tierStatus)}</div>
            </div>
            ${renderMilestones(tier.milestones, pattern.patternId, tierIndex + 1, tierStatus)}
          </div>
        `;
      }).join('');
    }

    function renderMilestones(milestones, patternId, tierNum, tierStatus) {
      if (!milestones || milestones.length === 0) {
        return '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">No milestones in this tier yet</p>';
      }

      return `
        <div class="milestones-grid">
          ${milestones.map(milestone => {
            const isLocked = tierStatus === 'locked';
            const clickHandler = isLocked ? '' : `onclick="selectMilestone('${patternId}', ${tierNum}, '${milestone.milestoneId}')"`;

            return `
              <div class="milestone-card ${milestone.status || (isLocked ? 'locked' : '')}" ${clickHandler}>
                <div class="milestone-header">
                  <h4 class="milestone-name">${milestone.name}</h4>
                  <span class="milestone-icon">${getMilestoneIcon(milestone.status)}</span>
                </div>
                <div class="milestone-description">${milestone.description || ''}</div>
                ${!isLocked ? `
                  <div class="milestone-progress">
                    <div class="milestone-progress-fill" style="width: ${milestone.progress || 0}%"></div>
                  </div>
                  <div class="milestone-stats">${milestone.problemsCorrect || 0}/${milestone.requiredProblems || 10} problems ¬∑ ${Math.round(milestone.progress || 0)}%</div>
                ` : '<div class="milestone-stats">üîí Complete previous tier</div>'}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function getTierIcon(tierNum) {
      const icons = ['ü•â', 'ü•à', 'ü•á', 'üíé', 'üëë', '‚≠ê'];
      return icons[tierNum - 1] || '‚≠ê';
    }

    function getTierStatus(tier, currentTier, tierNum) {
      if (tierNum > currentTier) return 'locked';
      if (tierNum === currentTier) return 'active';
      return 'completed';
    }

    function getTierStatusText(status) {
      const texts = {
        locked: 'üîí Locked',
        active: 'üöÄ In Progress',
        completed: '‚úÖ Completed'
      };
      return texts[status] || 'Available';
    }

    function getMilestoneIcon(status) {
      const icons = {
        'locked': 'üîí',
        'in-progress': 'üéØ',
        'completed': '‚úÖ'
      };
      return icons[status] || '‚≠ê';
    }

    function calculatePatternProgress(pattern) {
      if (!pattern.tiers || pattern.tiers.length === 0) return 0;

      let totalMilestones = 0;
      let completedMilestones = 0;

      pattern.tiers.forEach(tier => {
        if (tier.milestones) {
          tier.milestones.forEach(milestone => {
            totalMilestones++;
            if (milestone.status === 'completed') completedMilestones++;
          });
        }
      });

      return totalMilestones > 0 ? (completedMilestones / totalMilestones) * 100 : 0;
    }

    function togglePattern(patternId) {
      const card = document.getElementById(`pattern-${patternId}`);
      if (card) {
        card.classList.toggle('expanded');
      }
    }

    async function selectMilestone(patternId, tierNum, milestoneId) {
      try {
        const response = await csrfFetch('/api/mastery/select-milestone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ patternId, tierNum, milestoneId })
        });

        if (response.ok) {
          window.location.href = '/mastery-chat.html';
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to select milestone. Please try again.');
        }
      } catch (error) {
        console.error('Error selecting milestone:', error);
        alert('An error occurred. Please try again.');
      }
    }


    // Load daily quests
    async function loadDailyQuests() {
      try {
        const response = await fetch('/api/daily-quests');
        if (!response.ok) return;

        const data = await response.json();

        // Update streak
        const streakStat = document.getElementById('streak-count-stat');
        if (streakStat) streakStat.textContent = data.currentStreak || 0;

        const container = document.getElementById('mini-quests-container');
        if (!container) return;

        if (!data.quests || data.quests.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #999; font-size: 12px; padding: 10px;">No quests today</div>';
          return;
        }

        container.innerHTML = data.quests.slice(0, 3).map(quest => `
          <div class="quest-item">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <strong style="font-size: 12px;">${quest.name}</strong>
              <span style="font-size: 11px; color: #FFC107; font-weight: 700;">${quest.xpReward} XP</span>
            </div>
            <div style="font-size: 11px; color: #666; margin-bottom: 8px;">${quest.description}</div>
            <div style="height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
              <div style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: ${quest.progress}%; transition: width 0.3s;"></div>
            </div>
            <div style="font-size: 10px; color: #999; margin-top: 4px; font-weight: 600;">${quest.current}/${quest.target}</div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading quests:', error);
      }
    }

    // Load weekly challenges
    async function loadWeeklyChallenges() {
      try {
        const response = await fetch('/api/weekly-challenges');
        if (!response.ok) return;

        const data = await response.json();

        // Update timer
        updateChallengeTimer(data.weekStart);

        const container = document.getElementById('mini-challenges-container');
        if (!container) return;

        if (!data.challenges || data.challenges.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #999; font-size: 12px; padding: 10px;">No challenges this week</div>';
          return;
        }

        container.innerHTML = data.challenges.slice(0, 2).map(challenge => `
          <div class="quest-item">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <strong style="font-size: 12px;">${challenge.name}</strong>
              <span style="font-size: 11px; color: #FFA500; font-weight: 700;">${challenge.xpReward} XP</span>
            </div>
            <div style="font-size: 11px; color: #666; margin-bottom: 8px;">${challenge.description}</div>
            <div style="height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
              <div style="height: 100%; background: linear-gradient(90deg, #FFD93D 0%, #FFA500 100%); width: ${challenge.progress}%; transition: width 0.3s;"></div>
            </div>
            <div style="font-size: 10px; color: #999; margin-top: 4px; font-weight: 600;">${challenge.current}/${challenge.target}</div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading challenges:', error);
      }
    }

    function updateChallengeTimer(weekStart) {
      if (!weekStart) return;

      const timerElement = document.getElementById('time-remaining');
      if (!timerElement) return;

      function update() {
        const now = new Date();
        const start = new Date(weekStart);
        const nextMonday = new Date(start);
        nextMonday.setDate(nextMonday.getDate() + 7);

        const diff = nextMonday - now;
        if (diff <= 0) {
          timerElement.textContent = 'Resetting...';
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

        timerElement.textContent = `${days}d ${hours}h remaining`;
      }

      update();
      setInterval(update, 60000); // Update every minute
    }

    function logout() {
      localStorage.removeItem('userId');
      window.location.href = '/login.html';
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      loadMasteryMap();       // Load the new unified mastery map
      loadUserStats();        // Load user stats for sidebar
      loadDailyQuests();      // Load daily quests
      loadWeeklyChallenges(); // Load weekly challenges
    });
  </script>

  <!-- Auth & Session Scripts -->
  <!-- Load storage utilities FIRST to prevent tracking prevention errors -->
  <script src="/js/storage-utils.js"></script>
  <script src="/js/logout.js"></script>
  <script src="/js/auto-logout.js"></script>
<script src="/js/csrf.js"></script>
</body>
</html>
